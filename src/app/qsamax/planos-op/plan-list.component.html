<div class="breadcrumb-card mb-25 d-md-flex align-items-center justify-content-between">
    <h5 class="mb-0">Planos OP </h5>
    <ol class="breadcrumb list-unstyled mt-0 mb-0 pl-0">
        <li class="breadcrumb-item position-relative">
            <a routerLink="/" class="d-inline-block position-relative">
                <i class="ri-home-8-line"></i>
                Dashboard
            </a>
        </li>
        <li class="breadcrumb-item position-relative">DYD</li>
        <li class="breadcrumb-item position-relative">Planos OP</li>
    </ol>
</div>





<mat-card class="daxa-card to-do-list-card mb-25 border-radius bg-white border-none d-block">
  <mat-card-header>
    <mat-card-title>
        <button mat-stroked-button color="primary" (click)="openUploadPlanDialog()" class="ms-2">
                <mat-icon>add_circle_outline</mat-icon> Agregar Plano a OP
            </button>
    </mat-card-title>
    <mat-card-subtitle>
      <form class="search-box position-relative">
        <mat-form-field class="w-100">
          <mat-icon matPrefix>search</mat-icon>
          <input
            matInput
            placeholder="Buscar por orden o proyecto"
            class="input-search d-block w-100 border-none outline-0"
            (keyup)="applyFilter($event)"
          />
        </mat-form-field>
      </form>
    </mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <div class="table-responsive">
      <table mat-table [dataSource]="dataSource" multiTemplateDataRows class="objectives-table">

        <!-- Columnas principales -->
               <ng-container matColumnDef="idPlan">
          <th mat-header-cell *matHeaderCellDef>No de plan.</th>
          <td mat-cell *matCellDef="let plan">{{ plan.idPlan }}</td>
        </ng-container>

        <ng-container matColumnDef="production_order">
          <th mat-header-cell *matHeaderCellDef>Orden Prod.</th>
          <td mat-cell *matCellDef="let plan">{{ plan.production_order }}</td>
        </ng-container>

        <ng-container matColumnDef="project_name">
          <th mat-header-cell *matHeaderCellDef>Proyecto</th>
          <td mat-cell *matCellDef="let plan">{{ plan.project_name }}</td>
        </ng-container>

        <ng-container matColumnDef="user_name">
          <th mat-header-cell *matHeaderCellDef>Subido por</th>
          <td mat-cell *matCellDef="let plan">{{ plan.user_name }}</td>
        </ng-container>

        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef>Fecha</th>
          <td mat-cell *matCellDef="let plan">{{ plan.created_at | date:'short' }}</td>
        </ng-container>

        <!-- Botón expandir -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let plan">
             <!-- Nuevo botón para agregar detalle -->
          <button mat-icon-button matTooltip="Agregar Detalle" (click)="openAddDetailDialog(plan.idPlan)">
            <mat-icon>note_add</mat-icon>
          </button>

            <button mat-icon-button matTooltip="Ver Detalles" (click)="toggleDetail(plan)">
              <mat-icon>expand_more</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Fila de detalle -->
        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let plan" [attr.colspan]="displayedColumns.length">
            <div class="objective-detail-container"
                [@detailExpand]="plan == selectedPlan ? 'expanded' : 'collapsed'">
              <div *ngIf="plan.plan_details.length === 0" class="detail-no-data">
                No hay detalles de planos.
              </div>
              <div *ngIf="plan.plan_details.length > 0" class="detail-table-wrapper">
                <h6 class="detail-table-title">Detalles de Plano para: {{ plan.project_name }}</h6>
                <table mat-table [dataSource]="plan.plan_details" class="detail-table">

                  <ng-container matColumnDef="file_name">
                    <th mat-header-cell *matHeaderCellDef>Archivo</th>
                    <td mat-cell *matCellDef="let detail">{{ detail.file_name }}</td>
                  </ng-container>

                  <ng-container matColumnDef="plan_type">
                    <th mat-header-cell *matHeaderCellDef>Tipo</th>
                    <td mat-cell *matCellDef="let detail">{{  detail.plan_type?.name }}</td>
                  </ng-container>

                  <ng-container matColumnDef="plan_review">
                    <th mat-header-cell *matHeaderCellDef>Revisión</th>
                    <td mat-cell *matCellDef="let detail">{{ detail.plan_review }}</td>
                  </ng-container>

         
                

                  <ng-container matColumnDef="uploaded_by">
                    <th mat-header-cell *matHeaderCellDef>Subido por</th>
                    <td mat-cell *matCellDef="let detail">{{ detail.uploaded_by }}</td>
                  </ng-container>

                  <ng-container matColumnDef="upload_at">
                    <th mat-header-cell *matHeaderCellDef>Fecha</th>
                    <td mat-cell *matCellDef="let detail">{{ detail.upload_at | date:'short' }}</td>
                  </ng-container>

                    <ng-container matColumnDef="file_path">
                    <th mat-header-cell *matHeaderCellDef>Ruta</th>
                    <td mat-cell *matCellDef="let detail">{{ detail.file_path }}</td>
                  </ng-container>

                  <ng-container matColumnDef="descargar">
                    <th mat-header-cell *matHeaderCellDef>Descargar</th>
                    <td mat-cell *matCellDef="let detail">
                        <button mat-icon-button matTooltip="Descargar" (click)="downloadFile(detail.file_path)">
                        <mat-icon>download</mat-icon>
                        </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumnsDetail; sticky: true"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumnsDetail;"></tr>
                </table>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Cabeceras y filas -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="toggleDetail(row)"></tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="objective-detail-row"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="displayedColumns.length">
            No hay planos disponibles.
          </td>
        </tr>
      </table>
    </div>
  </mat-card-content>
</mat-card>
